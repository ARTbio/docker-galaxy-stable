#!/usr/bin/env bash

# Convert a Github Flavored Markdown Syntax file to HTML for the landing page
# using CSS stylesheet and JS scripts
#
# This script is highly based on the one of Evertton de Lima available on
# https://gist.github.com/evertton/4133083
#
# Requirements: cURL (sudo apt-get install curl)
# Input/Output: filename/STDOUT
#
# Usage: gfm2html <input> <output>
# * input: filename of the Github Flavored Markdown (GFM) syntax document
# * output: filename of the HTML document to generate
#
# eg: ./gfm2html README.md index.html
set -e

function format_text {
text=$1
text=${text//\"/\\\"}
text=${text//	/\\\t}
text=${text//
/\\\n}
echo $text
}

function generate_html {
result=$(curl --silent https://api.github.com/markdown -d "{\"text\": \"$1\", \"mode\": \"gfm\", \"context\": \"\"}")
stringtosearch='"message": '
if `echo $result | grep "$stringtosearch" 1>/dev/null 2>&1`
then
  echo $result
  exit 1
fi
echo $result
}

# read markdown file
if [[ ! -n "$1" ]]; then
    echo "No input file specified!"
    exit 1
elif [[ -d "$1" ]]; then
    echo "$1 is a directory."
    exit 1
elif [[ ! -e "$1" ]]; then
    echo "The file $1 not exist!"
    exit 1
elif [[ ! -r "$1" ]]; then
    echo "The $1 file cannot be read! Verify the permissions!"
    exit 1
else
    header=$(head -n 6 $1)
    formatted_header=$(format_text "$header")
    doc=$(tail -n +8 "$1")
    formatted_doc=$(format_text "$doc")
fi

if [[ ! -n "$2" ]]; then
  echo "No output file specified!"
  exit 1
fi

echo "$formatted_doc"
html_formatted_header=$(generate_html "$formatted_header")
html_formatted_doc=$(generate_html "$formatted_doc")
#generate_html $formatted_doc
#echo $html_formatted_doc

# output html
echo "<!doctype html>
<html>
  <head>
    <meta charset=\"utf-8\">
    <meta http-equiv=\"X-UA-Compatible\" content=\"chrome=1\">
    <title>Galaxy Docker Image by bgruening</title>

    <link rel=\"stylesheet\" href=\"css/landing_page.css\">
    <meta name=\"viewport\" content=\"width=device-width\">
    <!--[if lt IE 9]>
    <script src=\"//html5shiv.googlecode.com/svn/trunk/html5.js\"></script>
    <![endif]-->
  </head>

<body>
  <div class=\"wrapper\">
    <header>
      <h1>Galaxy Docker Image</h1>
      <p>Docker Images tracking the stable Galaxy releases</p>

      "$html_formatted_header"

      <p class=\"view\"><a href=\"https://github.com/bgruening/docker-galaxy-stable\">View the Project on GitHub <small>bgruening/docker-galaxy-stable</small></a></p>

      <ul>
        <li><a href=\"https://github.com/bgruening/docker-galaxy-stable/zipball/master\">Download <strong>ZIP File</strong></a></li>
        <li><a href=\"https://github.com/bgruening/docker-galaxy-stable/tarball/master\">Download <strong>TAR Ball</strong></a></li>
        <li><a href=\"https://github.com/bgruening/docker-galaxy-stable\">View On <strong>GitHub</strong></a></li>
      </ul>
    </header>

    <section>
    "$html_formatted_doc"

    </section>

    <footer>
      <p>This project is maintained by <a href=\"https://github.com/bgruening\">bgruening</a></p>
      <p><small>Hosted on GitHub Pages &mdash; Theme by <a href=\"https://github.com/orderedlist\">orderedlist</a></small></p>
    </footer>
    <script src=\"js/landing_page.js\"></script>
  </div>
</body>
</html>" > $2
